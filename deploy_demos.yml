---

- name: Get nodes from Inventory and add to Groups
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
  - name: Get AAP node
    set_fact:
      node_name: "{{ item }}"
    loop: "{{ groups['all'] }}"
    when: hostvars[item].tags is defined and hostvars[item].tags.Name | regex_search("^aap-(.*)$")

  - name: Add aap node to the aap group
    add_host:
      name: "{{ node_name }}"
      groups: "aap"
    when: node_name is defined

- name: Create baseline AAP configs
  hosts: localhost
  connection: local
  gather_facts: no
  vars_files: ../vars/main.yml
  vars:
    aap_hostname: "{{ groups['aap'][0] }}"
    aap_username: admin
    aap_password: "{{ admin_password }}"
    aap_configuration_enforce_defaults: true
    aap_validate_certs: false
  pre_tasks:
    - name: Include CaC from controller.yml file
      ansible.builtin.include_vars: '../configs/controller.yml'
  roles:
    - {role: infra.aap_configuration.controller_projects, when: controller_projects is defined}
    - {role: infra.aap_configuration.controller_credentials, when: controller_credentials is defined}
    - {role: infra.aap_configuration.controller_inventories, when: controller_inventories is defined}
    - {role: infra.aap_configuration.controller_hosts, when: controller_hosts is defined}
    - {role: infra.aap_configuration.controller_job_templates, when: controller_templates is defined}